

### 入侵排查：

#### 1. 开启打印机日志

```powershell
$logDeets = Get-LogProperties 'Microsoft-Windows-PrintService/Operational'
$logDeets.Enabled = $true
Set-LogProperties -LogDetails $logDeets
Get-LogProperties 'Microsoft-Windows-PrintService/Operational'
```

<img src="https://cdn.jsdelivr.net/gh/mask75/imgs@master/20210703021900.PNG" alt="IMG_3249 2" style="zoom: 67%;" />

<img src="https://cdn.jsdelivr.net/gh/mask75/imgs@master/20210703021932.PNG" alt="IMG_3249" style="zoom:67%;" />

> 无论漏洞是否利用成功都会生成此日志，123.dll 就是恶意dll文件名

### 处置建议：

#### 1. 更新补丁

```
及时更新Windows安全补丁
```

#### 2. 限制ACL：

> ⚠️提供一个临时变通方法，使漏洞利用无效，同时允许您保持打印机服务的运行，直到补丁可用

该漏洞通过在C:\Windows\System32\spool\drivers下的子目录中删除DLL来工作,通过限制此目录（和子目录）上的ACL，可以防止打印机服务引入恶意DLL。目前，不知道任何方法可以强制将 DLL 投放到其它位置。

**为驱动程序目录和所有子目录添加拒绝规则，防止SYSTEM帐户修改其内容**

```powershell
$Path = "C:\Windows\System32\spool\drivers"

$Acl = (Get-Item $Path).GetAccessControl('Access')

$Ar = New-Object  System.Security.AccessControl.FileSystemAccessRule("System", "Modify", "ContainerInherit, ObjectInherit", "None", "Deny")

$Acl.AddAccessRule($Ar)

Set-Acl $Path $Acl
```

如果管理员需要执行需要服务在这些目录中写入的配置更改，则可以暂时删除此规则，并在更改后重新添加。

```powershell
$Path = "C:\Windows\System32\spool\drivers"

$Acl = (Get-Item $Path).GetAccessControl('Access')

$Ar = New-Object System.Security.AccessControl.FileSystemAccessRule("System", "Modify", "ContainerInherit, ObjectInherit", "None", "Deny")

$Acl.RemoveAccessRule($Ar)

Set-Acl $Path $Acl
```

#### 3. 禁用打印机服务

```
在服务应用（services.msc）中禁用 Print Spooler服务
```

